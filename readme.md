# Cloud-Proxy HA Setup

This directory contains everything needed to stand up a two-node, high-availability
Nginx Proxy Manager cluster. Configs are generated by **setup-ha.sh**:

- **MariaDB Galera Cluster**
- **Keepalived** for floating-IP failover
- **Syncthing** for bidirectional sync of `/opt/npm-data`

Source repo: https://github.com/jsbrain/cloud-proxy.git

---

## Prerequisites

- Ubuntu 20.04+ (root or sudo)
- Network connectivity between both hosts
- Hetzner Cloud CLI authenticated (via "hcloud auth login" nach Installation)

---

## Quickstart

1. Clone on both hosts:
   ```bash
   git clone https://github.com/jsbrain/cloud-proxy.git
   cd cloud-proxy
   ```
2. Make script executable and run it:
   ```bash
   chmod +x setup-ha.sh
   ./setup-ha.sh
   ```

---

## Beispiel: Alle Variablen per Umgebungsvariable setzen

Vor dem Ausführen müssen alle Variablen exportiert werden, um Eingabeaufforderungen zu vermeiden:

```bash
export HOST_IP='10.0.0.2'
export PEER_IPS='10.0.0.2,10.0.0.3'
export FLOATING_IP='10.0.0.100'
export ROLE='MASTER'
export PRIORITY='150'
export SYNCTHING_DEVICE_ID='ABCDEF1234567890'
export SYNCTHING_PEER_DEVICE_IDS='ID1,ID2'
export DB_ROOT_PASS='secureRootPass'
export DB_USER='npmuser'
export DB_USER_PASS='secureUserPass'
export DB_NAME='npmdb'
export CLUSTER_NAME='npm-galera'
export XTRABACKUP_PASSWORD='secureXbckPass'
./setup-ha.sh
```

---

## Environment Variables

| Variable                    | Beschreibung                               |
| --------------------------- | ------------------------------------------ |
| `HOST_IP`                   | this host’s IP                             |
| `PEER_IPS`                  | comma-separated peer IPs                   |
| `FLOATING_IP`               | VRRP floating IP                           |
| `ROLE`                      | Keepalived role (`MASTER` oder `BACKUP`)   |
| `PRIORITY`                  | VRRP priority (höher gewinnt)              |
| `SYNCTHING_DEVICE_ID`       | this host’s Syncthing Device ID            |
| `SYNCTHING_PEER_DEVICE_IDS` | comma-separated peer Syncthing IDs         |
| `DB_ROOT_PASS`              | MariaDB root password (erforderlich)       |
| `DB_USER`                   | MariaDB user name (erforderlich)           |
| `DB_USER_PASS`              | MariaDB user password (erforderlich)       |
| `DB_NAME`                   | MariaDB database name (erforderlich)       |
| `CLUSTER_NAME`              | Galera cluster name (erforderlich)         |
| `XTRABACKUP_PASSWORD`       | XtraBackup password for SST (erforderlich) |
